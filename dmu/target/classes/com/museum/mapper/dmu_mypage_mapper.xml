<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "mapper.mypage">

	<!-- ///////////////////////////// mypage_reservation ///////////////////////////// -->
	<!-- mypage reservation, ticket content -->
	<resultMap id = "purchaseInfo" type = "com.museum.vo.DmuPurchaseVO">
		<id property = "rid" column = "RID"/>
		<id property = "pid" column = "PID"/>
		<result property = "did" column = "DID"/>
		<result property = "mid" column = "MID"/>
		<result property = "rdate" column = "RDATE"/>
		<result property = "rtotal" column = "RTOTAL"/>
		<result property = "rcheck" column = "RCHECK"/>
		<result property = "mid" column = "MID"/>
		<result property = "rokdate" column = "ROKDATE"/>
		<result property = "rfaildate" column = "RFAILEDATE"/>
		<result property = "rprice" column = "RPRICE"/>
		<result property = "rallprice" column = "RALLPRICE"/>
		<result property = "pcoin" column = "PCOIN"/>
		<result property = "pdate" column = "PDATE"/>
		<result property = "pallprice" column = "PALLPRICE"/>
		<association property = "ticketVo" resultMap = "ticketInfo"/>
		<collection column = "rid = rid" property = "ticketList" ofType = "com.museum.vo.DmuPurchaseTicketVO"
			select = "purchaseTicketList"></collection>
	</resultMap>
	
	<resultMap id = "ticketInfo" type = "com.museum.vo.DmuTicketVO">
		<id property = "did" column = "DID"/>
		<result property = "dnum" column = "DNUM"/>
		<result property = "dtitle" column = "DTITLE"/>
		<result property = "dstart" column = "DSTART"/>
		<result property = "dend" column = "DEND"/>
		<result property = "dprice" column = "DPRICE"/>
		<result property = "dplace" column = "DPLACE"/>
		<result property = "dtime" column = "DTIME"/>
		<result property = "dfile" column = "DFILE"/>
		<result property = "dsfile" column = "DSFILE"/>
		<result property = "dcode" column = "DCODE"/>
		<result property = "dinformation" column = "DINFORMATION"/>
		<result property = "dtarget" column = "DTARGET"/>
		<result property = "dtitle2" column = "DTITLE2"/>
		<result property = "dpersonnel" column = "DPERSONNEL"/>
	</resultMap>
	
	<select id = "purchaseList" parameterType = "map" resultMap = "purchaseInfo">
		SELECT DT.DID, DR.RID, DT.DTITLE, DT.DTIME, DT.DPLACE, DT.DSFILE, TO_CHAR(DR.ROKDATE, 'YYYY-MM-DD HH24:MI:SS') ROKDATE, 
		       DR.RTOTAL, DR.RPRICE, DR.RCHECK, DR.RDATE, DP.PDATE, DP.PALLPRICE, DP.PCOIN, DT.DCODE
		FROM DMU_TICKET DT, DMU_RESERVATION DR, DMU_PAYINFO DP
		WHERE DT.DID = DR.DID AND DR.RID = DP.RID AND DR.RID = #{rid}
	</select>
	
	<select id = "purchaseTicketList" parameterType = "com.museum.vo.DmuPurchaseVO" resultType = "com.museum.vo.DmuPurchaseTicketVO">
		SELECT DP.PDATE, DP.PALLPRICE, DTI.TID, CASE WHEN DR.RDATE > SYSDATE AND DTI.TCHECK != 'n' THEN DTI.TCHECK ELSE 'expire' END AS TCHECK
		FROM DMU_TICKETINFO DTI, DMU_PAYINFO DP, DMU_RESERVATION DR
		WHERE DTI.RID = DP.RID AND DTI.RID = DR.RID AND  DTI.RID = #{rid}
	</select>
	
	<!-- RESERVATION EXPIRE -->
	<update id = "reservation_expire" parameterType = "java.lang.String">
		UPDATE DMU_RESERVATION SET RCHECK = 'ex' WHERE RID = #{rid}
	</update>
	
	<!-- RESERVATION TICKETINFO EXPIRE -->
	<update id = "reservation_ticket_expire" parameterType = "java.lang.String">
		UPDATE DMU_TICKETINFO SET TCHECK = 'ex' WHERE RID = #{rid}
	</update>
	
	<!-- TICKET UPDATE -->
	<update id = "ticket_update" parameterType = "java.util.List">
		UPDATE DMU_TICKETINFO SET TCHECK = 'n' WHERE TID = #{tid}		
	</update>
	
	<!-- TICKET COUNTING -->
	<select id = "ticket_cancle_totalCount" parameterType = "java.lang.String" resultType = "int">
		SELECT COUNT(*) FROM DMU_TICKETINFO WHERE RID = #{rid} AND TCHECK = 'n'
	</select>
	
	<!-- TICKET RESERVATION UPDATE -->
	<update id = "ticket_reservation_update" parameterType = "java.lang.String">
		UPDATE DMU_RESERVATION SET RCHECK = 'n' WHERE RID = #{rid}
	</update>
	
	<!-- ///////////////////////////// mypage_inquiry ///////////////////////////// -->
	<!-- mypage inquiry insert -->
	<insert id = "inquiry_insert" parameterType = "com.museum.vo.DmuInquiryVO">
		INSERT INTO DMU_INQUIRY 
		VALUES('iq_' || SEQU_DMU_INQUIRY.NEXTVAL, #{mid}, #{iqcategory}, #{iqtype}, #{iqtitle}, #{iqcontent}, 'n', SYSDATE)   
	</insert>
	
	<!-- mypage inquiry totalCount -->
	<select id = "inquiry_totalCount" parameterType = "java.lang.String" resultType = "int">
		SELECT COUNT(*) FROM DMU_INQUIRY WHERE MID = #{mid}
	</select>
	
	<!-- mypage inquiry list -->
	<select id = "inquiry_list" parameterType = "map" resultType = "com.museum.vo.DmuInquiryVO">
		SELECT RNO, IQID, IQCATEGORY, IQTYPE, IQTITLE, IQANSWER, TO_CHAR(IQDATE, 'YYYY-MM-DD') IQDATE
		FROM (SELECT ROWNUM RNO, IQID, IQCATEGORY, IQTYPE, IQTITLE, IQANSWER, IQDATE
		FROM (SELECT IQID, IQCATEGORY, IQTYPE, IQTITLE, IQANSWER, IQDATE
		     FROM DMU_INQUIRY WHERE MID = #{mid} ORDER BY IQDATE DESC))
		WHERE RNO BETWEEN #{start} AND #{end}
	</select>
	
	<select id = "inquiry_content" parameterType = "java.lang.String" resultType = "com.museum.vo.DmuInquiryVO">
		SELECT IQID, IQCATEGORY, IQTYPE, IQTITLE, IQCONTENT, IQANSWER, TO_CHAR(IQDATE, 'YYYY-MM-DD') IQDATE
		FROM DMU_INQUIRY WHERE IQID = #{iqid}
	</select>


	<!-- ///////////////////////////// mypage_member ///////////////////////////// -->
	<!-- member content -->
	<select id = "member_info" parameterType = "java.lang.String" resultType = "com.museum.vo.DmuMemberVO">
		SELECT MID,
			CONCAT(SUBSTR(MID, 1, 4), '***') MID_SECURITY,
	        LPAD(' ', 10, '*') PASS,
	        CASE WHEN NATIONALITY = 'local' THEN '내국인' ELSE '외국인' END AS NATIONALITY,
	        CASE WHEN GENDER = 'm' THEN '남자' ELSE '여자' END AS GENDER,
	        REPLACE(MNAME, SUBSTR(MNAME, 2, LENGTH(MNAME)-2), '*') MNAME,
	        TO_CHAR(BIRTH, 'YYYY.MM.') || '**' AS BIRTH,
	        SUBSTR(PNUMBER, 1, 4) || '****' || SUBSTR(PNUMBER, 9, 13) AS PNUMBER,
	        SUBSTR(EMAIL, 1, 4) || '*****' || SUBSTR(EMAIL, INSTR(EMAIL, '@', 1), LENGTH(EMAIL)) AS EMAIL,
	        ADDR1 || ' ' || ADDR2 AS ADDRESS
		FROM DMU_MEMBER
		WHERE MID = #{mid}
	</select>
	
	<!-- member info update -->
	<update id = "member_info_update" parameterType = "map">
		<choose>
			<when test = 'type == "password"'>
				UPDATE DMU_MEMBER SET PASS = #{vo.pass} WHERE MID = #{vo.mid}
			</when>
			<when test = 'type == "address"'>
				UPDATE DMU_MEMBER SET ZONECODE = #{vo.zonecode}, ADDR1 = #{vo.addr1}, ADDR2 = #{vo.addr2} 
				WHERE MID = #{vo.mid}
			</when>
		</choose>
	</update>
	
	<!-- member unregister -->
	<update id = "member_unregister" parameterType = "java.lang.String">
		UPDATE DMU_MEMBER SET UNREGISTER = 'n' WHERE MID = #{mid}
	</update>
</mapper>